#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Interaktywny konwerter DjVu -> PDF (wersja konsolowa).

Ten skrypt pozwala u≈ºytkownikom na konwersjƒô plik√≥w DjVu do formatu PDF
przy u≈ºyciu narzƒôdzia wiersza polece≈Ñ `ddjvu`. Jest zaprojektowany z my≈õlƒÖ
o ≈Çatwo≈õci obs≈Çugi i dobrze dzia≈Ça w systemie Windows, gdzie `ddjvu.exe` jest popularne.
"""

import os
import sys
import subprocess
import glob
from pathlib import Path
import shutil

def znajdz_ddjvu():
    """Znajduje ≈õcie≈ºkƒô do pliku wykonywalnego ddjvu.

    Sprawdza najpierw zmiennƒÖ ≈õrodowiskowƒÖ DJVU_PATH. Je≈õli nie zostanie znaleziona,
    przeszukuje systemowƒÖ zmiennƒÖ PATH w poszukiwaniu 'ddjvu' lub 'ddjvu.exe'.

    Zwraca:
        str: Pe≈Çna ≈õcie≈ºka do pliku wykonywalnego ddjvu lub None, je≈õli nie znaleziono.
    """
    env_path = os.environ.get('DJVU_PATH')
    if env_path:
        if os.path.isfile(env_path) and os.access(env_path, os.X_OK):
            return env_path
        # Je≈õli podano katalog, spr√≥buj znale≈∫ƒá w nim ddjvu
        if os.path.isdir(env_path):
            candidate = os.path.join(env_path, 'ddjvu.exe' if os.name == 'nt' else 'ddjvu')
            if os.path.isfile(candidate) and os.access(candidate, os.X_OK):
                return candidate

    # Szukaj w PATH
    for name in ('ddjvu', 'ddjvu.exe'):
        path = shutil.which(name)
        if path:
            return path

    return None

def znajdz_pliki_djvu(katalog):
    """Znajduje wszystkie pliki DjVu w podanym katalogu.

    Args:
        katalog (str): ≈öcie≈ºka do katalogu do przeszukania.

    Zwraca:
        list[str]: Posortowana lista ≈õcie≈ºek do znalezionych plik√≥w DjVu.
    """
    wzorce = ['*.djvu', '*.djv', '*.DJVU', '*.DJV']
    pliki = []
    for wzorzec in wzorce:
        pliki.extend(glob.glob(os.path.join(katalog, wzorzec)))
    return sorted(pliki)

def wyswietl_pliki(pliki):
    """Wy≈õwietla numerowanƒÖ listƒô plik√≥w wraz z ich rozmiarami.

    Args:
        pliki (list[str]): Lista ≈õcie≈ºek plik√≥w do wy≈õwietlenia.
    """
    if not pliki:
        print("‚ùå Nie znaleziono plik√≥w DjVu w podanym katalogu.")
        return
    print(f"\nüìÅ Znaleziono {len(pliki)} plik√≥w DjVu:")
    print("-" * 60)
    for i, sciezka_pliku in enumerate(pliki, 1):
        nazwa_pliku = os.path.basename(sciezka_pliku)
        try:
            rozmiar_mb = os.path.getsize(sciezka_pliku) / (1024 * 1024)
            rozmiar_str = f"{rozmiar_mb:.1f} MB"
        except Exception:
            rozmiar_str = "??"
        print(f"{i:2d}. {nazwa_pliku} ({rozmiar_str})")

def wybierz_konkretne_pliki(pliki):
    """Prosi u≈ºytkownika o wybranie konkretnych plik√≥w z listy po numerach.

    U≈ºytkownik mo≈ºe podaƒá numery oddzielone przecinkami lub zakresy (np. "1,3,5-7").

    Args:
        pliki (list[str]): Lista plik√≥w do wyboru.

    Zwraca:
        list[str]: Lista ≈õcie≈ºek plik√≥w wybranych przez u≈ºytkownika.
    """
    while True:
        wybor = input("\nPodaj numery plik√≥w (np. 1,3,5 lub 1-5): ").strip()
        try:
            wybrane_indeksy = set()
            for czesc in wybor.split(','):
                czesc = czesc.strip()
                if not czesc:
                    continue
                if '-' in czesc:
                    start, koniec = map(int, czesc.split('-'))
                    wybrane_indeksy.update(range(start, koniec + 1))
                else:
                    wybrane_indeksy.add(int(czesc))
            if not wybrane_indeksy:
                print("‚ùå Nic nie wybrano.")
                continue
            if all(1 <= i <= len(pliki) for i in wybrane_indeksy):
                return [pliki[i-1] for i in sorted(wybrane_indeksy)]
            else:
                print(f"‚ùå Numery muszƒÖ byƒá z zakresu 1-{len(pliki)}")
        except ValueError:
            print("‚ùå Nieprawid≈Çowy format. U≈ºyj numer√≥w i zakres√≥w (np. 1,3,5 lub 1-5).")

def wybierz_pliki_do_konwersji(pliki):
    """Umo≈ºliwia u≈ºytkownikowi wyb√≥r plik√≥w do konwersji.

    Args:
        pliki (list[str]): Lista dostƒôpnych plik√≥w.

    Zwraca:
        list[str] | None: Lista wybranych ≈õcie≈ºek plik√≥w lub None, aby wr√≥ciƒá.
    """
    while True:
        print("\nüîß Opcje wyboru:")
        print("1. Wszystkie pliki")
        print("2. Wybierz konkretne pliki (np. 1,3,5 lub 1-5)")
        print("3. Powr√≥t do wyboru katalogu")
        wybor = input("\nTw√≥j wyb√≥r: ").strip()
        if wybor == '1':
            return pliki
        elif wybor == '2':
            return wybierz_konkretne_pliki(pliki)
        elif wybor == '3':
            return None
        else:
            print("‚ùå Nieprawid≈Çowy wyb√≥r. Spr√≥buj ponownie.")

def wybierz_jakosc():
    """Prosi u≈ºytkownika o wyb√≥r jako≈õci konwersji.

    Zwraca:
        str: Wybrany poziom jako≈õci ('low', 'normal' lub 'high').
    """
    print("\nüé® Wybierz jako≈õƒá konwersji:")
    print("1. Niska (szybka, ma≈Çy rozmiar)")
    print("2. Normalna (zalecana)")
    print("3. Wysoka (wolna, du≈ºy rozmiar)")
    while True:
        wybor = input("\nTw√≥j wyb√≥r (1-3): ").strip()
        if wybor == '1':
            return 'low'
        elif wybor == '2':
            return 'normal'
        elif wybor == '3':
            return 'high'
        else:
            print("‚ùå Wybierz 1, 2 lub 3.")

def konwertuj_plik(sciezka_ddjvu, plik_djvu, katalog_wyjsciowy, jakosc='normal', timeout_s=300):
    """Konwertuje pojedynczy plik DjVu do formatu PDF za pomocƒÖ narzƒôdzia ddjvu.

    Args:
        sciezka_ddjvu (str): ≈öcie≈ºka do pliku wykonywalnego ddjvu.
        plik_djvu (str): ≈öcie≈ºka do ≈∫r√≥d≈Çowego pliku DjVu.
        katalog_wyjsciowy (str): Katalog, w kt√≥rym ma byƒá zapisany przekonwertowany plik PDF.
        jakosc (str, optional): Jako≈õƒá konwersji.
            Mo≈ºe byƒá 'low', 'normal' lub 'high'. Domy≈õlnie 'normal'.
        timeout_s (int, optional): Timeout konwersji w sekundach.
            Domy≈õlnie 300.

    Zwraca:
        bool: True, je≈õli konwersja siƒô powiod≈Ça, w przeciwnym razie False.
    """
    nazwa_bazowa = os.path.splitext(os.path.basename(plik_djvu))[0]
    plik_pdf = os.path.join(katalog_wyjsciowy, f"{nazwa_bazowa}.pdf")
    parametry_jakosci = {
        'low': ['-quality=25', '-smooth'],
        'normal': ['-quality=75'],
        'high': ['-quality=100', '-smooth']
    }
    params = parametry_jakosci.get(jakosc, ['-quality=75'])
    cmd = [sciezka_ddjvu, '-format=pdf'] + params + [plik_djvu, plik_pdf]
    print(f"üîÑ Konwertujƒô: {os.path.basename(plik_djvu)} -> {os.path.basename(plik_pdf)}")
    try:
        wynik = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout_s)
        if wynik.returncode == 0:
            try:
                rozmiar_mb = os.path.getsize(plik_pdf) / (1024 * 1024)
                print(f"‚úÖ Utworzono: {os.path.basename(plik_pdf)} ({rozmiar_mb:.1f} MB)")
            except Exception:
                print(f"‚úÖ Utworzono: {os.path.basename(plik_pdf)}")
            return True
        else:
            print(f"‚ùå B≈ÇƒÖd konwersji (kod {wynik.returncode}). stdout/stderr:")
            if wynik.stdout:
                print("---- STDOUT ----")
                print(wynik.stdout)
            if wynik.stderr:
                print("---- STDERR ----")
                print(wynik.stderr)
            return False
    except subprocess.TimeoutExpired:
        print(f"‚ùå Przekroczono limit czasu ({timeout_s}s) dla pliku: {os.path.basename(plik_djvu)}")
        return False
    except FileNotFoundError:
        print("‚ùå Nie znaleziono ddjvu ‚Äî sprawd≈∫ czy ddjvu.exe jest w PATH lub DJVU_PATH.")
        return False
    except Exception as e:
        print(f"‚ùå Nieoczekiwany b≈ÇƒÖd: {e}")
        return False

def main():
    """G≈Ç√≥wna funkcja uruchamiajƒÖca interaktywny konwerter DjVu na PDF."""
    print("=" * 60)
    print("üîÑ KONWERTER DjVu ‚Üí PDF (Windows-friendly)")
    print("=" * 60)

    sciezka_ddjvu = znajdz_ddjvu()
    if not sciezka_ddjvu:
        print("‚ùå Nie znaleziono programu ddjvu.")
        print("   - Dodaj ddjvu.exe do systemowej zmiennej PATH lub ustaw zmiennƒÖ ≈õrodowiskowƒÖ DJVU_PATH.")
        print("   - Strona projektu: http://djvu.sourceforge.net/")
        sys.exit(1)
    else:
        print(f"‚ÑπÔ∏è  Wykryto ddjvu: {sciezka_ddjvu}")

    while True:
        print(f"\nüìÇ Aktualny katalog: {os.getcwd()}")
        katalog = input("Podaj ≈õcie≈ºkƒô do katalogu z plikami DjVu (Enter = aktualny): ").strip()
        if not katalog:
            katalog = os.getcwd()
        if not os.path.isdir(katalog):
            print("‚ùå Podany katalog nie istnieje!")
            continue

        pliki_djvu = znajdz_pliki_djvu(katalog)
        wyswietl_pliki(pliki_djvu)
        if not pliki_djvu:
            if input("\nSpr√≥bowaƒá inny katalog? (t/n): ").lower().startswith('t'):
                continue
            else:
                break

        wybrane_pliki = wybierz_pliki_do_konwersji(pliki_djvu)
        if wybrane_pliki is None:
            continue

        katalog_wyjsciowy = input(f"\nKatalog docelowy (Enter = {katalog}): ").strip()
        if not katalog_wyjsciowy:
            katalog_wyjsciowy = katalog
        Path(katalog_wyjsciowy).mkdir(parents=True, exist_ok=True)

        jakosc = wybierz_jakosc()

        try:
            timeout_s = int(input("\nTimeout konwersji w sekundach (Enter = 300): ").strip() or "300")
        except ValueError:
            timeout_s = 300

        print(f"\nüìã Podsumowanie:")
        print(f"   Plik√≥w do konwersji: {len(wybrane_pliki)}")
        print(f"   Katalog docelowy: {katalog_wyjsciowy}")
        print(f"   Jako≈õƒá: {jakosc}")
        print(f"   Timeout: {timeout_s}s")

        if not input("\nRozpoczƒÖƒá konwersjƒô? (t/n): ").lower().startswith('t'):
            continue

        licznik_sukcesow = 0
        licznik_bledow = 0
        for sciezka_pliku in wybrane_pliki:
            if konwertuj_plik(sciezka_ddjvu, sciezka_pliku, katalog_wyjsciowy, jakosc, timeout_s):
                licznik_sukcesow += 1
            else:
                licznik_bledow += 1

        print("\n" + "=" * 60)
        print("üìä PODSUMOWANIE")
        print("=" * 60)
        print(f"‚úÖ Pomy≈õlnie skonwertowano: {licznik_sukcesow}")
        print(f"‚ùå B≈Çƒôdy: {licznik_bledow}")
        print(f"üìÅ Pliki PDF zapisano w: {katalog_wyjsciowy}")

        if not input("\nKonwertowaƒá kolejne pliki? (t/n): ").lower().startswith('t'):
            break

    print("\nüëã Dziƒôkujƒô za skorzystanie z konwertera!")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n‚èπÔ∏è  Program przerwany przez u≈ºytkownika.")
        sys.exit(0)
    except Exception as e:
        print(f"\n‚ùå Nieoczekiwany b≈ÇƒÖd: {e}")
        sys.exit(1)